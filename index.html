<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indian Estimate Maker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; min-height: 100vh; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 28px; margin-bottom: 5px; }
        .header p { opacity: 0.9; font-size: 14px; }
        .content { padding: 30px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 14px; }
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; transition: border-color 0.3s; font-family: inherit; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; }
        .autocomplete-container { position: relative; }
        .autocomplete-list { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #667eea; border-top: none; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .autocomplete-list.show { display: block; }
        .autocomplete-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
        .autocomplete-item:hover { background: #f5f5f5; }
        .party-balance { margin-top: 10px; padding: 12px; background: #f0f9ff; border-left: 4px solid #3b82f6; border-radius: 4px; }
        .party-balance strong { color: #1e40af; }
        .balance-positive { color: #059669; }
        .balance-negative { color: #dc2626; }
        .items-section { margin-top: 30px; padding-top: 30px; border-top: 2px solid #f0f0f0; }
        .item-row { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 10px; margin-bottom: 15px; align-items: end; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-info { background: #3b82f6; color: white; }
        .btn-info:hover { background: #2563eb; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-warning:hover { background: #d97706; }
        .btn-danger { background: #ef4444; color: white; padding: 8px 12px; font-size: 14px; }
        .btn-danger:hover { background: #dc2626; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover { background: #4b5563; }
        .btn-small { padding: 8px 16px; font-size: 14px; }
        .additional-charges { margin-top: 30px; padding: 20px; background: #f9fafb; border-radius: 8px; }
        .additional-charges h3 { margin-bottom: 15px; color: #333; }
        .charge-item { display: grid; grid-template-columns: 2fr 1fr auto; gap: 10px; margin-bottom: 10px; align-items: end; }
        .total-section { margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white; }
        .total-row { display: flex; justify-content: space-between; font-size: 24px; font-weight: bold; }
        .action-buttons { display: flex; gap: 15px; margin-top: 30px; flex-wrap: wrap; }
        .action-buttons .btn { flex: 1; min-width: 140px; }
        
        /* Estimate Preview Styles */
        #estimatePreview { display: none; background: white; padding: 40px; max-width: 800px; margin: 0 auto; }
        .estimate-header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #667eea; }
        .estimate-header h1 { color: #667eea; font-size: 32px; margin-bottom: 10px; }
        .estimate-info { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .info-box { padding: 15px; background: #f9fafb; border-radius: 8px; }
        .info-box h3 { color: #667eea; margin-bottom: 10px; font-size: 16px; }
        
        /* Fixed Table Styles */
        .estimate-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; table-layout: fixed; }
        .estimate-table th { background: #667eea; color: white; padding: 12px 8px; text-align: left; font-weight: 600; font-size: 14px; }
        .estimate-table td { padding: 12px 8px; border-bottom: 1px solid #e0e0e0; word-wrap: break-word; }
        .estimate-table th:nth-child(1), .estimate-table td:nth-child(1) { width: 8%; text-align: center; }
        .estimate-table th:nth-child(2), .estimate-table td:nth-child(2) { width: 35%; }
        .estimate-table th:nth-child(3), .estimate-table td:nth-child(3) { width: 15%; text-align: center; }
        .estimate-table th:nth-child(4), .estimate-table td:nth-child(4) { width: 20%; text-align: right; }
        .estimate-table th:nth-child(5), .estimate-table td:nth-child(5) { width: 22%; text-align: right; }
        .estimate-table tr:last-child td { border-bottom: 2px solid #667eea; }
        
        .estimate-summary { width: 100%; margin-top: 20px; }
        .summary-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e0e0e0; font-size: 16px; }
        .summary-row.total { font-size: 24px; font-weight: bold; color: #667eea; border-top: 3px solid #667eea; border-bottom: 3px solid #667eea; margin-top: 10px; padding: 15px 0; }
        .summary-row.balance { font-size: 20px; font-weight: 600; margin-top: 15px; padding-top: 15px; border-top: 2px solid #e0e0e0; }
        
        .qr-section { text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e0e0e0; }
        .qr-section h3 { color: #667eea; margin-bottom: 15px; }
        .qr-code { display: inline-block; padding: 15px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; }
        
        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow-y: auto; }
        .modal-content { background: white; margin: 5% auto; padding: 30px; border-radius: 15px; max-width: 600px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-height: 85vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { color: #333; }
        .close { font-size: 28px; font-weight: bold; cursor: pointer; color: #999; }
        .close:hover { color: #333; }
        .payment-list, .history-list, .party-list { max-height: 400px; overflow-y: auto; margin-top: 20px; }
        .payment-item, .history-item, .party-item { padding: 15px; background: #f9fafb; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #667eea; }
        .payment-item { display: flex; justify-content: space-between; align-items: center; }
        .payment-info { flex: 1; }
        .payment-actions { display: flex; gap: 8px; flex-shrink: 0; }
        .history-item { cursor: pointer; transition: all 0.3s; }
        .history-item:hover { background: #f0f0f0; transform: translateX(5px); }
        .party-item { display: flex; justify-content: space-between; align-items: center; }
        
        .edit-payment-form { background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #ffc107; }
        .edit-payment-form h4 { color: #856404; margin-bottom: 15px; }
        
        @media (max-width: 768px) {
            .item-row { grid-template-columns: 1fr; }
            .charge-item { grid-template-columns: 1fr; }
            .estimate-info { grid-template-columns: 1fr; }
            .action-buttons { flex-direction: column; }
            .action-buttons .btn { width: 100%; }
            .content { padding: 20px; }
            #estimatePreview { padding: 20px; }
            .estimate-table { font-size: 12px; }
            .estimate-table th, .estimate-table td { padding: 6px 4px; }
            .payment-item { flex-direction: column; align-items: flex-start; gap: 10px; }
            .payment-actions { width: 100%; }
            .payment-actions button { flex: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã Indian Estimate Maker</h1>
            <p>Create professional estimates with payment tracking</p>
        </div>
        <div class="content" id="formSection">
            <div class="form-group">
                <label for="partyName">Party Name *</label>
                <div class="autocomplete-container">
                    <input type="text" id="partyName" placeholder="Enter party name" autocomplete="off">
                    <div class="autocomplete-list" id="partyList"></div>
                </div>
                <div id="partyBalanceDisplay" class="party-balance" style="display: none;">
                    <strong>Current Balance:</strong> <span id="currentBalance">‚Çπ0.00</span>
                </div>
            </div>
            <div class="form-group">
                <label for="estimateDate">Estimate Date *</label>
                <input type="date" id="estimateDate">
            </div>
            <div class="items-section">
                <h3 style="margin-bottom: 20px; color: #333;">Items</h3>
                <div id="itemsContainer">
                    <div class="item-row">
                        <div class="form-group">
                            <label>Item Name</label>
                            <div class="autocomplete-container">
                                <input type="text" class="item-name" placeholder="Enter item name" autocomplete="off">
                                <div class="autocomplete-list item-list"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Quantity</label>
                            <input type="number" class="item-qty" placeholder="Qty" min="1" value="1">
                        </div>
                        <div class="form-group">
                            <label>Price (‚Çπ)</label>
                            <input type="number" class="item-price" placeholder="Price" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Total (‚Çπ)</label>
                            <input type="number" class="item-total" placeholder="Total" readonly>
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button class="btn btn-danger remove-item" style="display: none;">‚úï</button>
                        </div>
                    </div>
                </div>
                <button class="btn btn-success" id="addItem">+ Add Item</button>
            </div>
            <div class="additional-charges">
                <h3>Additional Charges</h3>
                <div id="chargesContainer">
                    <div class="charge-item">
                        <div class="form-group">
                            <label>Description</label>
                            <input type="text" class="charge-desc" placeholder="e.g., Transport, Courier" value="Old Balance">
                        </div>
                        <div class="form-group">
                            <label>Amount (‚Çπ)</label>
                            <input type="number" class="charge-amount" placeholder="0.00" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button class="btn btn-danger remove-charge" style="display: none;">‚úï</button>
                        </div>
                    </div>
                </div>
                <button class="btn btn-success" id="addCharge" style="margin-top: 10px;">+ Add Charge</button>
            </div>
            <div class="total-section">
                <div class="total-row">
                    <span>Total Amount:</span>
                    <span id="grandTotal">‚Çπ0.00</span>
                </div>
            </div>
            <div class="action-buttons">
                <button class="btn btn-primary" id="generateEstimate">Generate Estimate</button>
                <button class="btn btn-success" id="manageParties">Manage Parties</button>
                <button class="btn btn-info" id="managePayments">Manage Payments</button>
                <button class="btn btn-warning" id="viewHistory">View History</button>
                <button class="btn btn-secondary" id="resetForm">Reset Form</button>
            </div>
        </div>
        <div id="estimatePreview"></div>
    </div>

    <!-- Party Management Modal -->
    <div id="partyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Manage Parties</h2>
                <span class="close" data-modal="partyModal">&times;</span>
            </div>
            <div class="form-group">
                <label for="newPartyName">Party Name *</label>
                <input type="text" id="newPartyName" placeholder="Enter party name">
            </div>
            <button class="btn btn-primary" id="addParty" style="width: 100%; margin-bottom: 20px;">Add Party</button>
            <h3 style="margin-bottom: 15px; color: #333;">Existing Parties</h3>
            <div class="party-list" id="partyListView"></div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Manage Payments</h2>
                <span class="close" data-modal="paymentModal">&times;</span>
            </div>
            <div class="form-group">
                <label for="paymentParty">Select Party</label>
                <select id="paymentParty">
                    <option value="">-- Select Party --</option>
                </select>
            </div>
            <div id="partyPaymentSection" style="display: none;">
                <div class="party-balance" style="margin-bottom: 20px;">
                    <strong>Current Balance:</strong> <span id="modalBalance">‚Çπ0.00</span>
                </div>
                
                <!-- Edit Payment Form (Hidden by default) -->
                <div id="editPaymentForm" class="edit-payment-form" style="display: none;">
                    <h4>‚úèÔ∏è Edit Payment</h4>
                    <input type="hidden" id="editPaymentId">
                    <div class="form-group">
                        <label for="editPaymentAmount">Payment Amount (‚Çπ)</label>
                        <input type="number" id="editPaymentAmount" placeholder="Enter amount" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="editPaymentDate">Payment Date</label>
                        <input type="date" id="editPaymentDate">
                    </div>
                    <div class="form-group">
                        <label for="editPaymentNote">Note (Optional)</label>
                        <textarea id="editPaymentNote" rows="2" placeholder="Payment note"></textarea>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" id="saveEditPayment" style="flex: 1;">Save Changes</button>
                        <button class="btn btn-secondary" id="cancelEditPayment" style="flex: 1;">Cancel</button>
                    </div>
                </div>

                <!-- Add Payment Form -->
                <div id="addPaymentForm">
                    <div class="form-group">
                        <label for="paymentAmount">Payment Amount (‚Çπ)</label>
                        <input type="number" id="paymentAmount" placeholder="Enter amount" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="paymentDate">Payment Date</label>
                        <input type="date" id="paymentDate">
                    </div>
                    <div class="form-group">
                        <label for="paymentNote">Note (Optional)</label>
                        <textarea id="paymentNote" rows="2" placeholder="Payment note"></textarea>
                    </div>
                    <button class="btn btn-primary" id="addPayment" style="width: 100%;">Add Payment</button>
                </div>

                <h3 style="margin-top: 20px; margin-bottom: 10px; color: #333;">Payment History</h3>
                <div class="payment-list" id="paymentList"></div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Estimate History</h2>
                <span class="close" data-modal="historyModal">&times;</span>
            </div>
            <div class="form-group">
                <label for="historyParty">Filter by Party (Optional)</label>
                <select id="historyParty">
                    <option value="">-- All Parties --</option>
                </select>
            </div>
            <div class="history-list" id="historyList"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        const PARTIES_KEY = 'estimatePartiesData';
        const ITEMS_KEY = 'estimateItems';
        const HISTORY_KEY = 'estimateHistory';
        let currentEditingParty = null;

        function loadParties() {
            return JSON.parse(localStorage.getItem(PARTIES_KEY) || '{}');
        }

        function saveParties(parties) {
            localStorage.setItem(PARTIES_KEY, JSON.stringify(parties));
        }

        function loadSavedItems() {
            return JSON.parse(localStorage.getItem(ITEMS_KEY) || '[]');
        }

        function saveItems(items) {
            localStorage.setItem(ITEMS_KEY, JSON.stringify(items));
        }

        function loadHistory() {
            return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
        }

        function saveHistory(history) {
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
        }

        function getPartyBalance(partyName) {
            const parties = loadParties();
            if (!parties[partyName]) return 0;
            const invoices = parties[partyName].invoices || [];
            const payments = parties[partyName].payments || [];
            const totalInvoices = invoices.reduce((sum, inv) => sum + inv.amount, 0);
            const totalPayments = payments.reduce((sum, pay) => sum + pay.amount, 0);
            return totalInvoices - totalPayments;
        }

        function addInvoiceToParty(partyName, amount, date) {
            const parties = loadParties();
            if (!parties[partyName]) {
                parties[partyName] = { invoices: [], payments: [] };
            }
            parties[partyName].invoices.push({ amount, date, timestamp: Date.now() });
            saveParties(parties);
        }

        function addPaymentToParty(partyName, amount, date, note) {
            const parties = loadParties();
            if (!parties[partyName]) {
                parties[partyName] = { invoices: [], payments: [] };
            }
            const paymentId = Date.now();
            parties[partyName].payments.push({ id: paymentId, amount, date, note, timestamp: paymentId });
            saveParties(parties);
            return getPartyBalance(partyName);
        }

        function deletePayment(partyName, paymentId) {
            const parties = loadParties();
            if (parties[partyName] && parties[partyName].payments) {
                parties[partyName].payments = parties[partyName].payments.filter(p => p.id !== paymentId);
                saveParties(parties);
                return getPartyBalance(partyName);
            }
            return 0;
        }

        function updatePayment(partyName, paymentId, amount, date, note) {
            const parties = loadParties();
            if (parties[partyName] && parties[partyName].payments) {
                const payment = parties[partyName].payments.find(p => p.id === paymentId);
                if (payment) {
                    payment.amount = amount;
                    payment.date = date;
                    payment.note = note;
                    saveParties(parties);
                    return getPartyBalance(partyName);
                }
            }
            return 0;
        }

        function setupAutocomplete(input, listElement, dataSource) {
            input.addEventListener('input', function() {
                const value = this.value.toLowerCase();
                const data = typeof dataSource === 'function' ? dataSource() : dataSource;
                
                if (value.length === 0) {
                    listElement.classList.remove('show');
                    return;
                }

                const filtered = data.filter(item => item.toLowerCase().includes(value));
                
                if (filtered.length === 0) {
                    listElement.classList.remove('show');
                    return;
                }

                listElement.innerHTML = filtered.map(item => 
                    `<div class="autocomplete-item">${item}</div>`
                ).join('');
                
                listElement.classList.add('show');

                listElement.querySelectorAll('.autocomplete-item').forEach(item => {
                    item.addEventListener('click', function() {
                        input.value = this.textContent;
                        listElement.classList.remove('show');
                        if (input.id === 'partyName') {
                            updatePartyBalance();
                        }
                    });
                });
            });

            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !listElement.contains(e.target)) {
                    listElement.classList.remove('show');
                }
            });
        }

        function updatePartyBalance() {
            const partyName = document.getElementById('partyName').value.trim();
            const balanceDisplay = document.getElementById('partyBalanceDisplay');
            const balanceSpan = document.getElementById('currentBalance');
            
            if (partyName) {
                const balance = getPartyBalance(partyName);
                balanceSpan.textContent = `‚Çπ${balance.toFixed(2)}`;
                balanceSpan.className = balance >= 0 ? 'balance-negative' : 'balance-positive';
                balanceDisplay.style.display = 'block';
            } else {
                balanceDisplay.style.display = 'none';
            }
        }

        const partyInput = document.getElementById('partyName');
        const partyList = document.getElementById('partyList');
        setupAutocomplete(partyInput, partyList, () => Object.keys(loadParties()));

        partyInput.addEventListener('blur', updatePartyBalance);

        document.getElementById('estimateDate').valueAsDate = new Date();

        function calculateItemTotal(row) {
            const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
            const price = parseFloat(row.querySelector('.item-price').value) || 0;
            const total = qty * price;
            row.querySelector('.item-total').value = total.toFixed(2);
            calculateTotals();
        }

        function calculateTotals() {
            let itemsTotal = 0;
            document.querySelectorAll('.item-row').forEach(row => {
                itemsTotal += parseFloat(row.querySelector('.item-total').value) || 0;
            });

            let chargesTotal = 0;
            document.querySelectorAll('.charge-item').forEach(row => {
                chargesTotal += parseFloat(row.querySelector('.charge-amount').value) || 0;
            });

            const grandTotal = itemsTotal + chargesTotal;
            document.getElementById('grandTotal').textContent = `‚Çπ${grandTotal.toFixed(2)}`;
        }

        document.getElementById('addItem').addEventListener('click', function() {
            const container = document.getElementById('itemsContainer');
            const newRow = container.querySelector('.item-row').cloneNode(true);
            
            newRow.querySelectorAll('input').forEach(input => {
                if (!input.classList.contains('item-qty')) {
                    input.value = '';
                } else {
                    input.value = '1';
                }
            });
            
            newRow.querySelector('.remove-item').style.display = 'block';
            container.appendChild(newRow);
            
            setupItemRow(newRow);
            updateRemoveButtons('.item-row', '.remove-item');
        });

        document.getElementById('addCharge').addEventListener('click', function() {
            const container = document.getElementById('chargesContainer');
            const newRow = container.querySelector('.charge-item').cloneNode(true);
            
            newRow.querySelectorAll('input').forEach(input => {
                input.value = input.classList.contains('charge-desc') ? '' : '0';
            });
            
            newRow.querySelector('.remove-charge').style.display = 'block';
            container.appendChild(newRow);
            
            setupChargeRow(newRow);
            updateRemoveButtons('.charge-item', '.remove-charge');
        });

        function setupItemRow(row) {
            const itemNameInput = row.querySelector('.item-name');
            const itemList = row.querySelector('.item-list');
            setupAutocomplete(itemNameInput, itemList, loadSavedItems);

            row.querySelector('.item-qty').addEventListener('input', () => calculateItemTotal(row));
            row.querySelector('.item-price').addEventListener('input', () => calculateItemTotal(row));
            
            row.querySelector('.remove-item').addEventListener('click', function() {
                row.remove();
                calculateTotals();
                updateRemoveButtons('.item-row', '.remove-item');
            });
        }

        function setupChargeRow(row) {
            row.querySelector('.charge-amount').addEventListener('input', calculateTotals);
            row.querySelector('.remove-charge').addEventListener('click', function() {
                row.remove();
                calculateTotals();
                updateRemoveButtons('.charge-item', '.remove-charge');
            });
        }

        function updateRemoveButtons(rowSelector, buttonSelector) {
            const rows = document.querySelectorAll(rowSelector);
            rows.forEach((row) => {
                const removeBtn = row.querySelector(buttonSelector);
                removeBtn.style.display = rows.length > 1 ? 'block' : 'none';
            });
        }

        setupItemRow(document.querySelector('.item-row'));
        setupChargeRow(document.querySelector('.charge-item'));

        document.getElementById('generateEstimate').addEventListener('click', function() {
            const partyName = document.getElementById('partyName').value.trim();
            const estimateDate = document.getElementById('estimateDate').value;

            if (!partyName) {
                alert('Please enter party name');
                return;
            }

            const parties = loadParties();
            if (!parties[partyName]) {
                alert('Party not found. Please add the party first from "Manage Parties".');
                return;
            }

            if (!estimateDate) {
                alert('Please select estimate date');
                return;
            }

            const items = [];
            const itemNames = new Set();
            document.querySelectorAll('.item-row').forEach(row => {
                const itemName = row.querySelector('.item-name').value.trim();
                const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                const total = parseFloat(row.querySelector('.item-total').value) || 0;

                if (itemName && qty > 0 && price > 0) {
                    items.push({ itemName, qty, price, total });
                    itemNames.add(itemName);
                }
            });

            if (items.length === 0) {
                alert('Please add at least one item');
                return;
            }

            const charges = [];
            document.querySelectorAll('.charge-item').forEach(row => {
                const desc = row.querySelector('.charge-desc').value.trim();
                const amount = parseFloat(row.querySelector('.charge-amount').value) || 0;
                if (desc && amount !== 0) {
                    charges.push({ desc, amount });
                }
            });

            const savedItems = loadSavedItems();
            itemNames.forEach(name => {
                if (!savedItems.includes(name)) {
                    savedItems.push(name);
                }
            });
            saveItems(savedItems);

            let itemsTotal = items.reduce((sum, item) => sum + item.total, 0);
            let chargesTotal = charges.reduce((sum, charge) => sum + charge.amount, 0);
            const grandTotal = itemsTotal + chargesTotal;

            addInvoiceToParty(partyName, grandTotal, estimateDate);
            const newBalance = getPartyBalance(partyName);

            const history = loadHistory();
            history.unshift({
                id: Date.now(),
                partyName,
                date: estimateDate,
                items,
                charges,
                total: grandTotal,
                balance: newBalance,
                timestamp: Date.now()
            });
            saveHistory(history);

            generateEstimatePreview(partyName, estimateDate, items, charges, grandTotal, newBalance);
        });

        function generateEstimatePreview(partyName, estimateDate, items, charges, grandTotal, newBalance) {
            const formattedDate = new Date(estimateDate).toLocaleDateString('en-IN', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });

            const qrData = `Party: ${partyName}\nDate: ${formattedDate}\nAmount: ‚Çπ${grandTotal.toFixed(2)}`;

            let html = `
                <div class="estimate-header">
                    <h1>ESTIMATE</h1>
                    <p style="color: #666; font-size: 14px;">Professional Estimate Document</p>
                </div>
                <div class="estimate-info">
                    <div class="info-box">
                        <h3>Party Details</h3>
                        <p style="font-size: 18px; font-weight: 600; color: #333;">${partyName}</p>
                    </div>
                    <div class="info-box">
                        <h3>Estimate Date</h3>
                        <p style="font-size: 18px; font-weight: 600; color: #333;">${formattedDate}</p>
                    </div>
                </div>
                <table class="estimate-table">
                    <thead>
                        <tr>
                            <th>S.No</th>
                            <th>Item Name</th>
                            <th>Quantity</th>
                            <th>Price (‚Çπ)</th>
                            <th>Total (‚Çπ)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map((item, index) => `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${item.itemName}</td>
                                <td>${item.qty}</td>
                                <td>‚Çπ${item.price.toFixed(2)}</td>
                                <td>‚Çπ${item.total.toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <div class="estimate-summary">
                    ${charges.length > 0 ? charges.map(charge => `
                    <div class="summary-row">
                        <span>${charge.desc}:</span>
                        <span>‚Çπ${charge.amount.toFixed(2)}</span>
                    </div>`).join('') : ''}
                    <div class="summary-row total">
                        <span>Total Amount:</span>
                        <span>‚Çπ${grandTotal.toFixed(2)}</span>
                    </div>
                    <div class="summary-row balance" style="color: ${newBalance >= 0 ? '#dc2626' : '#059669'};">
                        <span>Current Balance:</span>
                        <span>‚Çπ${newBalance.toFixed(2)}</span>
                    </div>
                </div>
                <div class="qr-section">
                    <h3>Scan to Pay</h3>
                    <div class="qr-code" id="qrcode"></div>
                </div>
                <div style="margin-top: 40px; text-align: center;">
                    <button class="btn btn-primary" id="downloadEstimate">üì• Download as Image</button>
                    <button class="btn btn-secondary" id="backToForm" style="margin-left: 15px;">‚Üê Back to Form</button>
                </div>
            `;

            const preview = document.getElementById('estimatePreview');
            preview.innerHTML = html;
            preview.style.display = 'block';
            document.getElementById('formSection').style.display = 'none';

            new QRCode(document.getElementById("qrcode"), {
                text: qrData,
                width: 150,
                height: 150
            });

            document.getElementById('downloadEstimate').addEventListener('click', downloadEstimate);
            document.getElementById('backToForm').addEventListener('click', function() {
                preview.style.display = 'none';
                document.getElementById('formSection').style.display = 'block';
            });

            preview.scrollIntoView({ behavior: 'smooth' });
        }

        function downloadEstimate() {
            const button = document.getElementById('downloadEstimate');
            const backButton = document.getElementById('backToForm');
            button.style.display = 'none';
            backButton.style.display = 'none';

            html2canvas(document.getElementById('estimatePreview'), {
                scale: 2,
                backgroundColor: '#ffffff',
                logging: false
            }).then(canvas => {
                const link = document.createElement('a');
                const partyName = document.getElementById('partyName').value.trim();
                const date = new Date().toISOString().split('T')[0];
                link.download = `Estimate_${partyName}_${date}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();

                button.style.display = 'inline-block';
                backButton.style.display = 'inline-block';
            });
        }

        document.getElementById('resetForm').addEventListener('click', function() {
            if (confirm('Are you sure you want to reset the form?')) {
                document.getElementById('partyName').value = '';
                document.getElementById('estimateDate').valueAsDate = new Date();
                document.getElementById('partyBalanceDisplay').style.display = 'none';
                
                const itemsContainer = document.getElementById('itemsContainer');
                itemsContainer.innerHTML = `
                    <div class="item-row">
                        <div class="form-group">
                            <label>Item Name</label>
                            <div class="autocomplete-container">
                                <input type="text" class="item-name" placeholder="Enter item name" autocomplete="off">
                                <div class="autocomplete-list item-list"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Quantity</label>
                            <input type="number" class="item-qty" placeholder="Qty" min="1" value="1">
                        </div>
                        <div class="form-group">
                            <label>Price (‚Çπ)</label>
                            <input type="number" class="item-price" placeholder="Price" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Total (‚Çπ)</label>
                            <input type="number" class="item-total" placeholder="Total" readonly>
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button class="btn btn-danger remove-item" style="display: none;">‚úï</button>
                        </div>
                    </div>
                `;
                setupItemRow(itemsContainer.querySelector('.item-row'));

                const chargesContainer = document.getElementById('chargesContainer');
                chargesContainer.innerHTML = `
                    <div class="charge-item">
                        <div class="form-group">
                            <label>Description</label>
                            <input type="text" class="charge-desc" placeholder="e.g., Transport, Courier" value="Old Balance">
                        </div>
                        <div class="form-group">
                            <label>Amount (‚Çπ)</label>
                            <input type="number" class="charge-amount" placeholder="0.00" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button class="btn btn-danger remove-charge" style="display: none;">‚úï</button>
                        </div>
                    </div>
                `;
                setupChargeRow(chargesContainer.querySelector('.charge-item'));
                calculateTotals();
            }
        });

        // Modal Management
        const modals = {
            partyModal: document.getElementById('partyModal'),
            paymentModal: document.getElementById('paymentModal'),
            historyModal: document.getElementById('historyModal')
        };

        document.querySelectorAll('.close').forEach(btn => {
            btn.addEventListener('click', function() {
                const modalId = this.getAttribute('data-modal');
                modals[modalId].style.display = 'none';
            });
        });

        window.addEventListener('click', function(e) {
            Object.values(modals).forEach(modal => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });

        // Party Management
        document.getElementById('manageParties').addEventListener('click', function() {
            loadPartyList();
            modals.partyModal.style.display = 'block';
        });

        document.getElementById('addParty').addEventListener('click', function() {
            const partyName = document.getElementById('newPartyName').value.trim();
            
            if (!partyName) {
                alert('Please enter party name');
                return;
            }

            const parties = loadParties();
            if (parties[partyName]) {
                alert('Party already exists!');
                return;
            }

            parties[partyName] = { invoices: [], payments: [] };
            saveParties(parties);
            
            document.getElementById('newPartyName').value = '';
            loadPartyList();
            alert('Party added successfully!');
        });

        function loadPartyList() {
            const parties = Object.keys(loadParties());
            const list = document.getElementById('partyListView');
            
            if (parties.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No parties added yet</p>';
                return;
            }

            list.innerHTML = parties.map(partyName => {
                const balance = getPartyBalance(partyName);
                return `
                    <div class="party-item">
                        <div>
                            <strong>${partyName}</strong><br>
                            <small style="color: ${balance >= 0 ? '#dc2626' : '#059669'};">Balance: ‚Çπ${balance.toFixed(2)}</small>
                        </div>
                        <button class="btn btn-danger btn-small" onclick="deleteParty('${partyName.replace(/'/g, "\\'")}')">Delete</button>
                    </div>
                `;
            }).join('');
        }

        function deleteParty(partyName) {
            if (confirm(`Are you sure you want to delete party "${partyName}"? This will delete all invoices and payments.`)) {
                const parties = loadParties();
                delete parties[partyName];
                saveParties(parties);
                loadPartyList();
            }
        }

        // Payment Modal
        document.getElementById('managePayments').addEventListener('click', function() {
            const parties = Object.keys(loadParties());
            const select = document.getElementById('paymentParty');
            select.innerHTML = '<option value="">-- Select Party --</option>' + 
                parties.map(p => `<option value="${p}">${p}</option>`).join('');
            modals.paymentModal.style.display = 'block';
            
            // Hide edit form when opening modal
            document.getElementById('editPaymentForm').style.display = 'none';
            document.getElementById('addPaymentForm').style.display = 'block';
        });

        document.getElementById('paymentParty').addEventListener('change', function() {
            const partyName = this.value;
            const section = document.getElementById('partyPaymentSection');
            currentEditingParty = partyName;
            
            if (partyName) {
                const balance = getPartyBalance(partyName);
                document.getElementById('modalBalance').textContent = `‚Çπ${balance.toFixed(2)}`;
                document.getElementById('modalBalance').className = balance >= 0 ? 'balance-negative' : 'balance-positive';
                document.getElementById('paymentDate').valueAsDate = new Date();
                section.style.display = 'block';
                
                // Hide edit form and show add form
                document.getElementById('editPaymentForm').style.display = 'none';
                document.getElementById('addPaymentForm').style.display = 'block';
                
                loadPaymentHistory(partyName);
            } else {
                section.style.display = 'none';
            }
        });

        document.getElementById('addPayment').addEventListener('click', function() {
            const partyName = document.getElementById('paymentParty').value;
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const date = document.getElementById('paymentDate').value;
            const note = document.getElementById('paymentNote').value.trim();

            if (!amount || amount <= 0) {
                alert('Please enter a valid payment amount');
                return;
            }

            if (!date) {
                alert('Please select payment date');
                return;
            }

            const newBalance = addPaymentToParty(partyName, amount, date, note);
            document.getElementById('modalBalance').textContent = `‚Çπ${newBalance.toFixed(2)}`;
            document.getElementById('modalBalance').className = newBalance >= 0 ? 'balance-negative' : 'balance-positive';
            
            document.getElementById('paymentAmount').value = '';
            document.getElementById('paymentNote').value = '';
            
            loadPaymentHistory(partyName);
            alert('Payment added successfully!');
        });

        // Edit Payment Functions
        function showEditPaymentForm(partyName, paymentId, amount, date, note) {
            document.getElementById('editPaymentId').value = paymentId;
            document.getElementById('editPaymentAmount').value = amount;
            document.getElementById('editPaymentDate').value = date;
            document.getElementById('editPaymentNote').value = note || '';
            
            document.getElementById('editPaymentForm').style.display = 'block';
            document.getElementById('addPaymentForm').style.display = 'none';
            
            document.getElementById('editPaymentForm').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        document.getElementById('saveEditPayment').addEventListener('click', function() {
            const partyName = currentEditingParty;
            const paymentId = parseInt(document.getElementById('editPaymentId').value);
            const amount = parseFloat(document.getElementById('editPaymentAmount').value);
            const date = document.getElementById('editPaymentDate').value;
            const note = document.getElementById('editPaymentNote').value.trim();

            if (!amount || amount <= 0) {
                alert('Please enter a valid payment amount');
                return;
            }

            if (!date) {
                alert('Please select payment date');
                return;
            }

            const newBalance = updatePayment(partyName, paymentId, amount, date, note);
            document.getElementById('modalBalance').textContent = `‚Çπ${newBalance.toFixed(2)}`;
            document.getElementById('modalBalance').className = newBalance >= 0 ? 'balance-negative' : 'balance-positive';
            
            // Hide edit form and show add form
            document.getElementById('editPaymentForm').style.display = 'none';
            document.getElementById('addPaymentForm').style.display = 'block';
            
            loadPaymentHistory(partyName);
            alert('Payment updated successfully!');
        });

        document.getElementById('cancelEditPayment').addEventListener('click', function() {
            document.getElementById('editPaymentForm').style.display = 'none';
            document.getElementById('addPaymentForm').style.display = 'block';
        });

        function loadPaymentHistory(partyName) {
            const parties = loadParties();
            const party = parties[partyName];
            const list = document.getElementById('paymentList');
            
            if (!party || !party.payments || party.payments.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No payments recorded</p>';
                return;
            }

            list.innerHTML = party.payments.sort((a, b) => b.timestamp - a.timestamp).map(payment => `
                <div class="payment-item">
                    <div class="payment-info">
                        <strong style="font-size: 18px; color: #667eea;">‚Çπ${payment.amount.toFixed(2)}</strong><br>
                        <small style="color: #666;">üìÖ ${new Date(payment.date).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' })}</small>
                        ${payment.note ? `<br><small style="color: #666;">üìù ${payment.note}</small>` : ''}
                    </div>
                    <div class="payment-actions">
                        <button class="btn btn-info btn-small" onclick='showEditPaymentForm("${partyName.replace(/'/g, "\\'")}",${payment.id},${payment.amount},"${payment.date}","${(payment.note || '').replace(/"/g, '&quot;')}")'>‚úèÔ∏è Edit</button>
                        <button class="btn btn-danger btn-small" onclick='deletePaymentConfirm("${partyName.replace(/'/g, "\\'")}",${payment.id})'>üóëÔ∏è Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function deletePaymentConfirm(partyName, paymentId) {
            if (confirm('Are you sure you want to delete this payment?')) {
                const newBalance = deletePayment(partyName, paymentId);
                document.getElementById('modalBalance').textContent = `‚Çπ${newBalance.toFixed(2)}`;
                document.getElementById('modalBalance').className = newBalance >= 0 ? 'balance-negative' : 'balance-positive';
                
                loadPaymentHistory(partyName);
                alert('Payment deleted successfully!');
            }
        }

        // History Modal
        document.getElementById('viewHistory').addEventListener('click', function() {
            const parties = Object.keys(loadParties());
            const select = document.getElementById('historyParty');
            select.innerHTML = '<option value="">-- All Parties --</option>' + 
                parties.map(p => `<option value="${p}">${p}</option>`).join('');
            loadEstimateHistory();
            modals.historyModal.style.display = 'block';
        });

        document.getElementById('historyParty').addEventListener('change', loadEstimateHistory);

        function loadEstimateHistory() {
            const filterParty = document.getElementById('historyParty').value;
            const history = loadHistory();
            const list = document.getElementById('historyList');
            
            const filtered = filterParty ? history.filter(h => h.partyName === filterParty) : history;
            
            if (filtered.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No estimates found</p>';
                return;
            }

            list.innerHTML = filtered.map(estimate => `
                <div class="history-item" onclick='viewEstimateFromHistory(${JSON.stringify(estimate).replace(/'/g, "&apos;")})'>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <strong>${estimate.partyName}</strong>
                        <strong style="color: #667eea;">‚Çπ${estimate.total.toFixed(2)}</strong>
                    </div>
                    <div style="font-size: 14px; color: #666;">
                        ${new Date(estimate.date).toLocaleDateString('en-IN')} ‚Ä¢ ${estimate.items.length} items
                    </div>
                </div>
            `).join('');
        }

        function viewEstimateFromHistory(estimate) {
            modals.historyModal.style.display = 'none';
            generateEstimatePreview(
                estimate.partyName,
                estimate.date,
                estimate.items,
                estimate.charges,
                estimate.total,
                estimate.balance
            );
        }
    </script>
</body>
</html>